---
title: Extended Supplement for 'Identifying recent cholera infections using a
  multiplex bead assay'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,fig.height = 7,
                      fig.width = 10, eval=FALSE)
```




```{r functions,  eval=TRUE}

source("source/final_code/luminex_recommendation/R/packages.R")
source("source/final_code/shared/utils.R")


```


```{r data,  eval=TRUE}

source("source/final_code/luminex_recommendation/R/load-data.R")

case_days <- getTimingData()
demo_id <-getWideData() %>% mutate(blood=factor(blood))


#list of antigens associated with O1 cholera infection
O1_antigens <- c("CTHT","CtxB","InabaOSPBSA","OgawaOSPBSA","Sialidase","TcpA","VCC", #Luminex
                 "LPS") #ELISA

#data frame to join to make antigen names look nice for plots
antigen_df <- distinct(casecon_analysis,antigen) %>%
              filter(!is.na(antigen)) %>%
              mutate(O1_antigen= antigen %in% O1_antigens) %>%
              mutate(antigen_pretty = recode(antigen,
                                             "InabaOSPBSA" = "Inaba OSP",
                                             "OgawaOSPBSA" = "Ogawa OSP",
                                             "O139BSA" = "O139 OSP",
                                             "CTHT" = "CT-H",
                                             "CtxB" = "CT-B",
                                             "LTh" = "LT-H",
                                             "LTB"  = "LT-B",
                                             "LPS" = "Ogawa LPS"
                                             ))


```

\pagebreak

```{r captions2,  eval=TRUE}
vars <- list()

tab_nums <- captioner(prefix = "Table E", auto_space = FALSE)
fig_nums <- captioner(prefix = "Figure E", auto_space = FALSE)

fig_nums(name = "4param-loglogistic-1", caption = "Postive control dilution curve and four parameter log-logistic curve fits for Vibrio cholerae O1 antigen multiplex bead assay markers", display = FALSE)

fig_nums(name = "4param-loglogistic-2", caption = "Postive control dilution curve and four parameter log-logistic curve fits for additional antigen multiplex bead assay markers", display = FALSE)

fig_nums(name = "RAU-calc-1", caption = "Relationship between relative antibody units and median fluorescence intensity for additional antigen multiplex bead assay markers", display = FALSE)

fig_nums(name = "RAU-calc-2", caption = "Relationship between relative antibody units and median fluorescence intensity for non-Vibrio cholerae O1 antigen multiplex bead assay markers", display = FALSE)


fig_nums(name = "spaghetti-netmfi", caption = "Multiplex bead assay Net MFI measurements of IgG, IgM, and IgA against V. cholerae O1 antigens among culture confirmed cholera patients", display = FALSE)

fig_nums(name = "supp-spaghetti-netmfi", caption = "Multiplex bead assay Net MFI measurements of IgG, IgM, and IgA against additional antigens among culture confirmed cholera patients", display = FALSE)


tab_nums(name = "decay-model-parameterization", caption = "Biphasic and Exponential decay model comparison", display = FALSE)

fig_nums(name = "ind-trajectory-ogawaIgG", caption = "Individual-level trajectories of Ogawa OSP IgG", display = FALSE)
fig_nums(name = "ind-trajectory-ogawaIgA", caption = "Individual-level trajectories of Ogawa OSP IgA", display = FALSE)
fig_nums(name = "ind-trajectory-ogawaIgM", caption = "Individual-level trajectories of Ogawa OSP IgM", display = FALSE)

fig_nums(name = "ind-trajectory-ctIgG", caption = "Individual-level trajectories of CT-B IgG", display = FALSE)
fig_nums(name = "ind-trajectory-ctIgA", caption = "Individual-level trajectories of CT-B IgA", display = FALSE)
fig_nums(name = "ind-trajectory-ctIgM", caption = "Individual-level trajectories of CT-B IgM", display = FALSE)

tab_nums(name = "decay-model-estimation", caption = "Estimated duration of half-life and average fold-change from univariate exponential decay models", display = FALSE)

tab_nums(name = "decay-model-covariates", caption = "Relative parameter values for univariate exponential decay models including covariates for different serological markers", display = FALSE)


fig_nums(name = "fig2-netmfi", caption = "Estimated duration of half-life and average fold-change from exponential decay models fit to Net MFI measurements", display = FALSE)


fig_nums(name = "superlearner",
         caption="Comparison of cross-validated area under the ROC curve between ensemble and random forest models",
         display=FALSE)


fig_nums(name = "fig3-netmfi",
         caption="Cross-validated area under the receiver operating characteristic curve (cvAUC) and predictor importance rankings for Net MFI markers across random forest models with varying infection windows",
         display=FALSE)


tab_nums(name = "multi-marker-cvAUC", caption = "Comparison of cross-validated AUC between multiple marker random forest models using 45-day, 120-day, 200-day, and 300-day infection windows", display = FALSE)

tab_nums(name = "panel-select", caption = "Comparison of cross-validated AUC between multiplex bead assay IgG multiple marker random forest models using 45-day, 120-day, 200-day, and 300-day infection windows", display = FALSE)

fig_nums(name = "fig4-netmfi",
         caption="Comparison of cross-validated AUC across random forest models trained on traditional and Net MFI MBA serological markers for 45-day, 120-day, 200-day, and 300-day infection windows",
         display=FALSE)

fig_nums(name = "fig5-netmfi",
         caption="Specificity and time-varying sensitivity estimates of random forest models trained on traditional and Net MFI MBA serological markers with leave-one-out cross-validation for 45-day, 120-day, 200-day, and 300-day infection windows using different cut-offs",
         display=FALSE)



fig_nums(name = "no-ctb-cvAUC",
         caption="Comparison of cross-validated AUC across random forest models trained on traditional and MBA serological markers excluding anti-CT-B markers for 45-day, 120-day, 200-day, and 300-day infection windows",
         display=FALSE)

fig_nums(name = "marker-cutoff",
         caption="Marker cutoffs to detect recent infection within the past 120 days",
         display=FALSE)

```




### `r fig_nums("4param-loglogistic-1")`

Each point represents the median fluorescence intensity measurement (y-value) for a dilution (x-value) of pooled convalescent sera from confirmed positive *Vibrio cholerae* O1 patients. Each plate's dilution series were fit using a four-parameter log-logisitic regression (black lines). Shape of each point is unique to each plate.

```{r 4param-loglogistic-1, eval=TRUE}

parameters <- read_rds("source/final_code/luminex_recommendation/generated_rds/log_logistic_results/2021-10-18_4Ploglogistic_parameters.rds")%>%
            mutate(antigen=str_remove_all(antigen,":|-| "))


HiPos <- getLongLuminexTidy(reload = FALSE) %>%
            filter(str_detect(sample,"Hi Pos")) %>%
            filter(subclass=="total") %>%
            filter(str_detect(batch,"Case|Series"))  %>%
            mutate(antigen=str_remove_all(antigen,":|-| "))


#generate curve for each plate combination
curves <- data.frame()
combos<- distinct(HiPos, batch,isotype,antigen)
dilution_range <- 10^seq(1,7,by=0.1)
for(i in 1:nrow(combos)){
  
  param_tmp <- filter(parameters,
                      batch==combos$batch[i],
                      isotype==combos$isotype[i],
                      antigen==combos$antigen[i]
                      )
  
  curve_tmp <- data.frame(
                dilution=dilution_range,
                avgMFI=
                  getCurve4(param_tmp,dilution_range)) %>%
              mutate(batch=combos$batch[i],
              isotype=combos$isotype[i],
              antigen=combos$antigen[i]
              )
  
  curves <- bind_rows(curves,curve_tmp)
}


HiPos %>% filter(antigen %in% O1_antigens) %>%
            #rename some the antigen for plotting
            left_join(antigen_df) %>%
            rename(Isotype=isotype) %>%
    ggplot()+
    geom_line(data=curves%>% filter(antigen %in% O1_antigens)%>%
                            rename(Isotype=isotype) %>%
            #rename some the antigen for plotting
            left_join(antigen_df),
              aes(group=batch,
                  x=dilution,y=avgMFI),alpha=0.5
              )+
    geom_point(aes(x=dilution,y=avgMFI,col=Isotype,shape=batch),alpha=0.5)+
    facet_grid(Isotype~antigen_pretty)+
    scale_x_continuous("Dilution",trans="log10",breaks=c(10^2,10^5),minor_breaks = NULL)+
    scale_y_continuous("Median Fluorescence Intensity (MFI)",trans="log10")+
    scale_shape_manual(values=1:10)+
    theme_bw()+
    theme(legend.position = "none")


```

\pagebreak

### `r fig_nums("4param-loglogistic-2")`

Each point represents the median fluorescence intensity measurement (y-value) for a dilution (x-value) of pooled convalescent sera from confirmed positive *Vibrio cholerae* O1 patients. Each plate's dilution series were fit using a four-parameter log-logisitic regression (black lines). Shape of each point is unique to each plate.

```{r 4param-loglogistic-2, eval=TRUE}


HiPos %>% filter(!antigen %in% O1_antigens) %>%
            #rename some the antigen for plotting
            left_join(antigen_df) %>%
            rename(Isotype=isotype) %>%
    ggplot()+
    geom_line(data=curves%>% filter(!antigen %in% O1_antigens)%>%
                            rename(Isotype=isotype) %>%
            #rename some the antigen for plotting
            left_join(antigen_df),
              aes(group=batch,
                  x=dilution,y=avgMFI),alpha=0.5
              )+
    geom_point(aes(x=dilution,y=avgMFI,col=Isotype,shape=batch),alpha=0.5)+
    facet_grid(Isotype~antigen_pretty)+
    scale_x_continuous("Dilution",trans="log10",breaks=c(10^2,10^5),minor_breaks = NULL)+
    scale_y_continuous("Median Fluorescence Intensity (MFI)",trans="log10")+
    scale_shape_manual(values=1:10)+
    theme_bw()+
    theme(legend.position = "none")




```

\pagebreak

### `r fig_nums("RAU-calc-1")`

Relative antibody unit (RAU) measurements for each sample are plotted against the median fluorescence intensity (MFI) calculated from averaging triplicate measurements. Relative antibody units estimates were truncated at 10^2 and 10^5 (red points).

```{r RAU-calc-1, eval=TRUE}

analysisData$compare_data %>% 
                    filter(antigen %in% O1_antigens) %>%
                    left_join(antigen_df) %>%
                    ggplot(aes(x=avgMFI,y=RAU))+
                            geom_point(aes(col=RAU %in% c(-2,-5),shape=batch),alpha=0.1)+
                    ylab("log10(1/RAU)")+
                    scale_x_continuous("MFI",trans="log10")+
                    scale_color_manual(values=c("black","red"))+
                    scale_shape_manual(values=1:12)+
                    facet_grid(isotype~antigen_pretty)+
                    theme_cowplot()+
                    theme(axis.text.x = element_text(angle=45,hjust = 1),
                          legend.position = "none")



```

\pagebreak

### `r fig_nums("RAU-calc-2")`

Relative antibody unit (RAU) measurements for each sample are plotted against the median fluorescence intensity (MFI) calculated from averaging triplicate measurements. Relative antibody units estimates were truncated at 10^2 and 10^5 (red points). LT-B = heat labile toxin B subunit. LT-H = heat labile toxin holotoxin.

```{r RAU-calc-2, eval=TRUE}

analysisData$compare_data  %>% 
                    filter(!antigen %in% O1_antigens) %>%
                    left_join(antigen_df) %>%
                    ggplot(aes(x=avgMFI,y=RAU))+
                            geom_point(aes(col=RAU %in% c(-2,-5),shape=batch),alpha=0.1)+
                    ylab("log10(1/RAU)")+
                    scale_x_continuous("MFI",trans="log10")+
                    scale_color_manual(values=c("black","red"))+
                    scale_shape_manual(values=1:12)+
                    facet_grid(isotype~antigen_pretty)+
                    theme_cowplot()+
                    theme(axis.text.x = element_text(angle=45,hjust = 1),
                          legend.position = "none")

```

\pagebreak



```{r corr-rau-MFI, eval=FALSE}


### `r fig_nums("corr-rau-MFI")`

# Each point represents the Spearman rank correlation between the between the relative antibody unit (RAU) and net median fluorescence intensity for cases, by day of collection. Measurements were log10 transformed prior to calculating correlation.

analysisData$compare_data %>% 
        filter(!day %in% c(720,1080)) %>%
        filter(status=="Case")%>%
        group_by(antigen,isotype,day) %>%
        summarise(r=cor.test(~ `Net MFI` + RAU,method="spearman")$estimate,
                  p.value=cor.test(~ `Net MFI` + RAU,method="spearman")$p.value,
                  ) %>% rename(Isotype=isotype) %>%
        ggplot(aes(x=as.factor(day),y=r,shape=Isotype))+
                geom_point(aes(col=r<0.85),alpha=0.5)+
                facet_wrap(.~antigen)+
                scale_color_manual(values = c("black","red"))+
                xlab("Day")+
                ylab("Spearman Correlation")+
                theme_bw()

# \pagebreak


```


### `r fig_nums("spaghetti-netmfi")`

The y-axis indicates the log (base 10) of the Net MFI and the x-axis is the number of days post-infection (square-root transformed). Each colored line indicates individual trajectories over time. The Black solid line is a loess smooth function. 


```{r spaghetti-netmfi, eval=TRUE}


# add to supplement
# Y-axis indicates the log (base 10) of the relative antibody units (RAU) with limits at 10^-2 and 10-5. X-axis is in days and square-root transformed. Each colored line indicates individual trajectories over time. Black solid line is a Loess smooth function.

analysisData$netMFI_data$long_data %>% filter(status =="Case") %>%
                filter(test_type=="Luminex") %>%
                filter(antigen  %in% O1_antigens) %>%
                left_join(antigen_df) %>%
                mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
                ggplot(aes(x=day_actual,y=value))+
                        geom_line(aes(group=id,col=antigen_pretty),alpha=0.3)+
                        geom_smooth(se=FALSE,col="black",lty=1)+
                        facet_grid(isotype~antigen_pretty,scales = "free_y")+
                        ylab("log10(Net MFI)")+

                        scale_x_continuous(trans="sqrt",breaks=c(2,30,365,900))+
                        theme_bw()+
                        theme(panel.grid.minor = element_blank(),
                             panel.grid.major.x = element_blank(),
                             legend.position = "none"
                              )+
                        xlab("Days Post Infection")



```

\pagebreak


### `r fig_nums("supp-spaghetti-netmfi")`

The y-axis indicates log (base 10) of the Net MFI and the x-axis is the number of days post-infection (square-root transformed). Each colored line indicates individual trajectories over time. The Black solid line is a loess smooth function. 


```{r supp-spaghetti-netmfi, eval=TRUE}

 analysisData$netMFI_data$long_data %>%
                filter(status=="Case") %>%
                filter(test_type=="Luminex") %>%
                left_join(antigen_df) %>%
                filter(!O1_antigen) %>%
                mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
                ggplot(aes(x=day_actual,y=value))+
                        geom_line(aes(group=id,col=antigen_pretty),alpha=0.3)+
                        geom_smooth(se=FALSE,col="black",lty=1)+
                        facet_grid(isotype~antigen_pretty,scales = "free_y")+
                        ylab("log10(Net MFI)")+
                        
                        scale_x_continuous(trans="sqrt",breaks=c(2,30,365,900))+
                        theme_bw()+
                        theme(panel.grid.minor = element_blank(),
                             panel.grid.major.x = element_blank(),
                             legend.position = "none"
                              )+
                        xlab("Days Post Infection")


```


\pagebreak



### `r tab_nums("decay-model-parameterization")`

The expected log-predictive density (ELPD) and standard error difference was calculated using the loo R package. Asterisks denote that the ELPD  of the biphasic model (which includes more parameters) was over 1.96 standard errors larger than the ELPD of the exponential model.See Supplementary Appendix 2 for equations defining each model

```{r decay-model-parameterization, eval=TRUE}



loo_df <- read_rds(
            paste0("source/final_code/luminex_recommendation/generated_rds/decay_model_results/",
                   "fits-compare/",
                               "loo_df.rds"))  

compare_df_loo<- loo_df %>% 
            mutate(elpd_loo=round(elpd_loo,1)) %>%
            select(model,marker,elpd_loo) %>%
                      spread(model,elpd_loo)

compare_df_diff <- loo_df  %>% 
        select(model,marker,se_diff) %>%
        spread(model,se_diff) %>%
        mutate(diff=
                 ifelse(biphasic!=0,
                        (biphasic + exponential)*-1,
                        biphasic + exponential
                        )
                  ) %>%
        select(marker,diff) %>%
        mutate(diff=ifelse(diff>=1.96,paste0(sprintf("%.2f",diff),"*"),sprintf("%.2f",diff)))
        
left_join(compare_df_loo,compare_df_diff)   %>% 
        mutate(marker=str_replace_all(marker,"_"," ")) %>%
        mutate(marker=str_replace(marker,"Luminex","MBA")) %>%
        rename(`Biphasic - Exponential\nStandard Error Difference`=diff,
               Marker=marker,
               `Biphasic ELPD` = biphasic,
                `Exponential ELPD` = exponential
               ) %>%
        flextable::flextable() %>%
        flextable::align(j=2:4,part="all", align = "center" ) %>%
        flextable::fontsize(size = 9,part="all") %>%
        flextable::autofit()



```

\pagebreak


### `r fig_nums("ind-trajectory-ogawaIgG")`

Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ogawaIgG, eval=TRUE, fig.height=9}
##  Individual-level antibody trajectories

path <- "source/final_code/luminex_recommendation/generated_rds/decay_model_results/fits-compare/"
OgawaIgG <- read_rds(paste0(path,"compare-fit-RAU_IgG_OgawaOSPBSA.rds"))
OgawaIgA <- read_rds(paste0(path,"compare-fit-RAU_IgA_OgawaOSPBSA.rds"))
OgawaIgM <- read_rds(paste0(path,"compare-fit-RAU_IgM_OgawaOSPBSA.rds"))
CtxBIgG <- read_rds(paste0(path,"compare-fit-RAU_IgG_CtxB.rds"))
CtxBIgA <- read_rds(paste0(path,"compare-fit-RAU_IgA_CtxB.rds"))
CtxBIgM <- read_rds(paste0(path,"compare-fit-RAU_IgM_CtxB.rds"))


panel_plot<- function(fitobj){

        fit_thin<- fitobj$fits$exponential_5$fit %>% spread_draws(omega_ind[id_new],
                                                                               lambda_ind[id_new],
                                                                                D_ind[id_new],
                                                                               delta
        ) %>% filter(.draw %in% round(seq(1,max(.draw),length.out=1000)))


        fit_summary <- fitobj$fits$exponential_5$dat$id_df %>%
                expand(id_new,day=c(1,4,seq(5,1080,30))) %>%
                left_join(fit_thin) %>%
                left_join(distinct(fitobj$fits$exponential_5$dat$id_df,id_new,id)) %>%
                mutate(predicted=ifelse(day<5,omega_ind,omega_ind+lambda_ind*exp(-delta*day))) %>%
                mutate(predicted=
                               case_when(
                                       day < 5 ~ omega_ind,
                                       day >=5 & day < D_ind ~ omega_ind+(day-5)/(D_ind-5)*lambda_ind,
                                       day >= D_ind ~ omega_ind+lambda_ind*exp(-delta*(day-D_ind))
                               )
                ) %>%
                group_by(day,id) %>%
                summarize(median=median(predicted),
                          lb=quantile(predicted,0.025),
                          ub=quantile(predicted,0.975))

        fit_summary %>%
                ggplot()+
                geom_line(aes(x=day,y=median),col="red")+
                geom_ribbon(aes(x=day,ymin=lb,ymax=ub),alpha=0.2,
                            fill="red"
                            )+
                geom_point(data=filter(casecon_analysis,
                                       status=="Case",
                                       full_test==fitobj$marker
                ),
                aes(x=day_actual,y=value)
                )+
                xlab("Days Post Infection")+
                ylab("log10(1/RAU)")+
                facet_wrap(.~str_pad(as.numeric(as.factor(id)),
                           side="left",pad="0",width = 3))+
                theme_cowplot()

}



panel_plot(OgawaIgG) + ggtitle("Ogawa OSP IgG")   
```

\pagebreak

### `r fig_nums("ind-trajectory-ogawaIgA")`
Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ogawaIgA, eval=TRUE, fig.height=9}
panel_plot(OgawaIgA) + ggtitle("Ogawa OSP IgA")     
```

\pagebreak

### `r fig_nums("ind-trajectory-ogawaIgM")`
Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ogawaIgM, eval=TRUE, fig.height=9}
panel_plot(OgawaIgM) + ggtitle("Ogawa OSP IgM")     
```

\pagebreak

### `r fig_nums("ind-trajectory-ctIgG")`

Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ctIgG, eval=TRUE, fig.height=9}
panel_plot(CtxBIgG) + ggtitle("CT-B IgG")
```

\pagebreak

### `r fig_nums("ind-trajectory-ctIgA")`

Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ctIgA, eval=TRUE, fig.height=9}
panel_plot(CtxBIgA) + ggtitle("CT-B IgA")   
```

\pagebreak

### `r fig_nums("ind-trajectory-ctIgM")`

Each facet shows the log10(RAU) measurements for individuals over time (points). Solid line indicates the median value of exponential decay model. Shaded area is the 95% credible interval.

```{r ind-trajectory-ctIgM, eval=TRUE, fig.height=9}
panel_plot(CtxBIgM) + ggtitle("CT-B IgM")                               
```

\pagebreak

### `r tab_nums("decay-model-estimation")`

The median estimate duration of half-life (in days) and the median estimate increase in fold-change for the average individual are shown below as well as in Figure 2. 95% Bayesian Credible Intervals are shown in parentheses.

```{r decay-model-estimation, eval=TRUE}

summary_df <-read_rds(
            paste0("source/final_code/luminex_recommendation/generated_rds/decay_model_results/",
                   "fits-compare/",
                              "summary_df.rds"))  


calc <- summary_df %>% filter(model=="exponential")%>%
                        filter(str_detect(parameter,"foldchange|halflife")) %>%
                        filter(!str_detect(parameter,"log")) %>% 
                        select(marker,parameter,`X50.`,`X2.5.`,`X97.5.`) %>%
                        #extract quantile
                        gather(Quantile,value,-c(marker,parameter)) %>%
                        mutate(Quantile=str_remove(Quantile,"X")) %>%
                        mutate(Quantile=substr(Quantile,1,nchar(Quantile)-1)) %>%
                        #calculate foldchange and halflife
                        spread(parameter,value) %>%
                        rename(avg_FC=foldchange) %>% 
                        gather(measure,value,-c(marker,Quantile)) %>%
                        # bring together measure and Quantile and spread
                        mutate(measure_Quantile=paste(measure,Quantile,sep="_")) %>%
                        select(-measure,-Quantile) %>%
                        spread(measure_Quantile,value) %>%
                        #get antigen and isotype
                        mutate(antigen=str_remove(marker,"Luminex_")) %>%
                        mutate(antigen=str_remove(antigen,"IgG_|IgM_|IgA_")) %>% 
                        mutate(isotype=str_extract(marker,"IgG|IgM|IgA")) %>%
                        left_join(antigen_df) %>%
                        mutate(Antigen=ifelse(is.na(antigen_pretty),
                                              antigen,as.character(antigen_pretty))) %>%
                        mutate(Antigen=str_replace(Antigen,"_"," ")) 


vib_calc <- filter(calc,str_detect(marker,"Vibriocidal")) %>%
        select(-isotype) %>%
        mutate(Marker=str_replace(marker,"_"," "))



calc %>%       filter(str_detect(marker,"RAU")) %>%
  mutate(halflife=paste0(round(halflife_50)," (",
                                round(halflife_97.5),"-",
                                round(halflife_2.5),")"),
                avg_FC = paste0(sprintf("%.1f",avg_FC_50)," (",
                                sprintf("%.1f",avg_FC_2.5),"-",
                                sprintf("%.1f",halflife_97.5),")")
                    ) %>% select(Isotype=isotype,
                                 Antigen,
                                 `Half Life (95% CI) in days`=halflife,
                                 `Average Fold-Change (95% CI)`=avg_FC) %>%
                    flextable::flextable() %>%
                    flextable::merge_v(j="Isotype") %>%
                    flextable::valign(j="Isotype",valign = "top") %>%
                    flextable::fontsize(size = 9,part="all") %>%
                    flextable::autofit()


calc %>%       filter(!str_detect(marker,"NetMFI|RAU")) %>%
          mutate(Antigen=str_replace(Antigen,"_"," ")) %>%
  mutate(halflife=paste0(round(halflife_50)," (",
                                round(halflife_97.5),"-",
                                round(halflife_2.5),")"),
                avg_FC = paste0(sprintf("%.1f",avg_FC_50)," (",
                                sprintf("%.1f",avg_FC_2.5),"-",
                                sprintf("%.1f",halflife_97.5),")")
                    ) %>% select(
                                 Marker=Antigen,
                                 `Half Life (95% CI) in days`=halflife,
                                 `Average Fold-Change (95% CI)`=avg_FC) %>%
                    flextable::flextable() %>%
                    # flextable::merge_v(j="Isotype") %>%
                    # flextable::valign(j="Isotype",valign = "top") %>%
                    flextable::fontsize(size = 9,part="all") %>%
                    flextable::autofit()

```

\pagebreak


### `r tab_nums("decay-model-covariates")`

The median relative baseline value, median relative fold-change value, and median difference in days of half-life are reported. 95% Bayesian Credible intervals are shown in parentheses. Reference categories include male, non-O blood group, Inaba, and 10+ years old. 

```{r decay-model-covariates, eval=TRUE}

# summary_cov_df <- read_rds(
#            paste0("source/final_code/luminex_recommendation/generated_rds/decay_model_results/",
#                    # Sys.Date(),
#                    "2021-09-29-covariates/",
#                                # Sys.Date(),
#                    "2021-09-29-summary_cov_df.rds"))

summary_cov_df <- read_rds(
           paste0("source/final_code/luminex_recommendation/generated_rds/decay_model_results/covariates/summary_cov_df.rds"))


#Fold change difference table
FC_diff_table<- summary_cov_df %>% filter(str_detect(parameter,"baseline_ratio|foldchange_ratio")) %>%
                select(marker,covariate,parameter,`X2.5.`,`X50.`,`X97.5.`) %>%
                gather(quantile,value,-c(marker,covariate,parameter)) %>%
                # mutate(value=10^value) %>%
                spread(quantile,value) %>% 
                mutate(CI =paste0(signif(`X50.`,3)," (",
                       signif(`X2.5.`,3),"-",
                       signif(`X97.5.`,3),")")) %>%
                mutate(CI=ifelse((`X2.5.`<1)+(`X97.5.`>1)==2,CI,paste0(CI,"*"))) %>%
                select(marker,covariate,parameter,CI) %>%
                spread(parameter,CI)

#half life change difference table
HL_diff_table <- summary_cov_df %>% filter(str_detect(parameter,"halflife_diff")) %>%
                select(marker,covariate,parameter,`X2.5.`,`X50.`,`X97.5.`) %>%
                mutate(CI =paste0(round(`X50.`)," (",
                       round(`X2.5.`),"-",
                       round(`X97.5.`),")")) %>%
                mutate(CI=ifelse(`X2.5.`*`X97.5.`>0,paste0(CI,"*"),CI)) %>%
                select(marker,covariate,parameter,CI) %>%
                spread(parameter,CI)

FC_diff_table %>% left_join(HL_diff_table) %>% 
          mutate(Isotype=str_extract(marker,"Ig[G|A|M]")) %>%
          mutate(Assay=str_extract(marker,"RAU|ELISA|Vibriocidal_Ogawa|Vibriocidal_Inaba")) %>%
          mutate(Antigen=str_remove_all(marker,"RAU_Ig[G|A|M]_|ELISA_|_Ig[G|A|M]|Vibriocidal_Ogawa|Vibriocidal_Inaba")) %>%
        mutate(Assay=str_replace(Assay,"_","\n")) %>%
        mutate(Assay=str_replace(Assay,"Luminex","MBA")) %>%
        mutate(Antigen=str_remove(Antigen,"BSA")) %>%
        mutate(Antigen=str_replace(Antigen, "OSP"," OSP")) %>%
        mutate(Marker=paste (Assay,Isotype,Antigen)) %>%
        mutate(Marker=str_remove(Marker,"NA")) %>%
        arrange(Assay,Isotype,Antigen) %>%
          select(Marker,
                 Covariate=covariate,
                 `Ratio of\nBaseline Values`=baseline_ratio,
                 `Ratio of\nFold-Change Values`=foldchange_ratio,
                 `Difference in days\nof Half-Life`=halflife_diff,
                 # `Ratio of\nHalf-lives`=halflife_ratio

                 ) %>% 
        flextable::flextable() %>%
        flextable::merge_v(j=c("Marker")) %>%
        flextable::valign(j=c("Marker"),valign = "top") %>%
        flextable::highlight(j = "Ratio of\nBaseline Values", i = ~ str_detect(`Ratio of\nBaseline Values`,"\\*"), color = "gray90") %>%
        flextable::highlight(j = "Ratio of\nFold-Change Values", i = ~ str_detect(`Ratio of\nFold-Change Values`,"\\*"), color = "gray90") %>%
        flextable::highlight(j = "Difference in days\nof Half-Life", i = ~ str_detect(`Difference in days\nof Half-Life`,"\\*"), color = "gray90") %>%
        # flextable::highlight(j = "Ratio of\nHalf-lives", i = ~ str_detect(`Ratio of\nHalf-lives`,"\\*"), color = "gray90") %>%
        flextable::fontsize(x=.,size = 8, part = "all") %>%
        flextable::autofit()



```


\pagebreak

### `r fig_nums("fig2-netmfi")`

Each point indicates the median estimate of the average individual fold-rise from baseline to peak (y-value) and the median estimate of the half-life (x-value) for exponential decay univariate models. Marginal 95% credible intervals are shown as lines. Model estimates for the vibriocidal assay are shown for reference and are identical across panels. 

```{r fig2-netmfi, eval=TRUE, fig.height = 5}

sum_stat_df <- read_rds("source/final_code/luminex_recommendation/generated_rds/decay_model_results/fits-compare/summary_df.rds") %>% 
      filter(model=="exponential") 

# sum_stat_df <- summary_df %>%      filter(model=="exponential")


calc <- sum_stat_df %>% #filter(!str_detect(marker,"ELISA")) %>%
                        filter(str_detect(parameter,"foldchange|halflife")) %>%
                        select(marker,parameter,`X50.`,`X2.5.`,`X97.5.`) %>%
                        #extract quantile
                        gather(Quantile,value,-c(marker,parameter)) %>%
                        mutate(Quantile=str_remove(Quantile,"X")) %>%
                        mutate(Quantile=substr(Quantile,1,nchar(Quantile)-1)) %>%
                        #calculate foldchange and halflife
                        spread(parameter,value) %>%
                        # mutate(#halflife=log(2)/delta,
                        #        # avg_FC=ifelse(str_detect(marker,"Luminex"),
                        #        #               10^mu_lambda,
                        #        #               2^mu_lambda)
                        # ) %>% select(-foldchange) %>%
                        gather(measure,value,-c(marker,Quantile)) %>%
                        # bring together measure and Quantile and spread
                        mutate(measure_Quantile=paste(measure,Quantile,sep="_")) %>%
                        select(-measure,-Quantile) %>%
                        spread(measure_Quantile,value) %>%
                        #get antigen and isotype
                        mutate(antigen=str_remove(marker,"Luminex_|NetMFI_|RAU_")) %>%
                        mutate(antigen=str_remove(antigen,"IgG_|IgM_|IgA_")) %>%
                        mutate(isotype=str_extract(marker,"IgG|IgM|IgA")) %>%
                        left_join(antigen_df) %>%
                        rename(Antigen=antigen_pretty)


vib_calc <- filter(calc,str_detect(marker,"Vibriocidal")) %>%
        select(-isotype) %>%
        mutate(Marker=str_replace(marker,"_"," "))



calc %>%
      filter(str_detect(marker,"NetMFI")) %>%
      # filter(!str_detect(marker,"VCC|Sialidase|CTH")) %>%
      filter(antigen %in% O1_antigens) %>%
      mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
                ggplot(aes(x=halflife_50,foldchange_50))+
                        #luminex
                        geom_point(aes(col=Antigen))+
                        geom_linerange(aes(ymin=foldchange_2.5,ymax=foldchange_97.5,col=Antigen))+
                        geom_linerange(aes(xmax=halflife_2.5,xmin=halflife_97.5,col=Antigen))+
                        #vibriocidal
                        geom_point(data=vib_calc,aes(shape=Marker))+
                        geom_linerange(data=vib_calc,aes(ymin=foldchange_2.5,ymax=foldchange_97.5,
                                                         lty=Marker))+
                        geom_linerange(data=vib_calc,aes(xmax=halflife_2.5,xmin=halflife_97.5,
                                                         lty=Marker))+
                        scale_color_brewer(palette = "Set2")+
                        facet_wrap(.~isotype)+
                        theme_cowplot()+
                        scale_y_continuous("Average fold-change",trans="log2",#limits=c(1,128),
                                           breaks = c(2,8,32,128))+
                        scale_x_continuous("Half-life (days)",trans="log2",
                                           breaks=c(1,7,30,90,180,365),
                                           #limits = c(1,365)
                                           )+
  geom_hline(yintercept=1,lty=2,col="grey")+
        theme(axis.text.x = element_text(angle=45,hjust=1))

        



```


\pagebreak



### `r fig_nums("superlearner")`

Models were fit to 18 MBA markers and 3 demographic variables (age, sex, and blood type).  The ensemble model was created using the R package SuperLearner. Four different types of models were combined into the ensemble: Random Forest models (ranger), Lasso and Elastic-Net Regularized Generalized Linear Models (glmnet), Bayesian Additive Regression Trees (bartMachine), and Extreme Gradient Boosting (xgboost). All models were unweighted.


```{r superlearner, eval=TRUE}

cvAUC_SL <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/2_superL_cvAUC_df.rds")

cvAUC_SL %>% ggplot(aes(x=factor(end_window),y=cvAUC,col=Model))+
                geom_point(position = position_dodge2(width=0.1))+
                geom_linerange(aes(ymin=ci1,ymax=ci2),
                               position = position_dodge2(width=0.1))+
                theme_bw()+
                ylim(c(0.7,1))+
                xlab("Infection Window (days)")+
                theme(panel.grid.minor.y = element_blank())+
                facet_wrap(.~measure)

```


\pagebreak

### `r fig_nums("fig3-netmfi")`

Estimates of mean cvAUC (10-fold) and 95% confidence interval are shown for weighted and non-weighted models between 50- and 600-day infection windows at 10-day intervals (A). Rug plot shows the day of collection of samples from cases used in training models. Samples collected under 5 days since infection, over 600 days since infection, or from household contacts are not shown. For each infection window of weighted models, the rankings of predictors by their importance are shown on the y-axis (B). Colors of lines are unique to each predictor.

```{r fig3-netmfi, eval=TRUE}

#bring in cvAUC dataframe
cvAUCdf <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/1_scan_cvAUC_df.rds") %>%
        filter(predictors %in% c( "Net MFI Limited")) %>%
        # mutate(predictors=str_remove(predictors," Limited")) %>%
        mutate(Data=ifelse(weighted,"Weighted","Unweighted")) 


#plot the cvAUC scan across windows
p_tv_cvAUC <- cvAUCdf  %>% 
        filter(end_window<=600) %>%
        ggplot(aes(x=end_window,y=cvAUC,col=Data,fill=Data))+
                geom_line()+
                geom_ribbon(aes(ymin=ci1,ymax=ci2),alpha=0.1,col=NA)+
                geom_rug(data=wide_analysis %>% 
                                 filter(day_actual<600,
                                        day>2,
                                        status=="Case"
                                        ),
                         aes(x=day_actual),inherit.aes = FALSE,alpha=0.3)+
                theme_cowplot()+
                scale_x_continuous("Infection Window (Days)",
                                   breaks=c(30,90,180,270,365,540, 600),
                                           limits = c(5,600)
                                   )+
                 scale_y_continuous(breaks=c(0.8,0.85,0.9,0.95,1),
                                    limits=c(0.8,1)
                                    )+
                theme(legend.position="bottom")




#bring in importance dataframe (Part B)
importance_df <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/3_importance_df.rds") %>%
                        # limit to 21 and no weighting
                        filter(predictors=="Net MFI Limited") %>%
                        filter(weighted== TRUE)


#define which variables you want to have a color
color_variable <- importance_df %>% 
                filter(str_detect(marker,"CtxB|OgawaOSPBSA|InabaOSPBSA")) %>%
                distinct(marker) %>% pull(marker) %>%
                c("age",.) 


#create data frame that makes names look nice and sets rankings
plot_df <- importance_df %>%  
                mutate(isotype= str_extract(marker,"Ig[G|A|M]")) %>%
                mutate(pretty_marker=str_remove(marker,"NetMFI_Ig[A|G|M]_")) %>%
                mutate(pretty_marker=str_replace(pretty_marker,"OSPBSA"," OSP")) %>%
                mutate(pretty_marker=str_replace(pretty_marker,"CtxB","CT-B")) %>%
                mutate(pretty_marker=
                               case_when(
                                       str_detect(marker,"Luminex|NetMFI|RAU") ~ paste0(pretty_marker," ",isotype),
                                   marker=="age" ~ "Age",
                                   marker=="sex" ~"Sex",
                                   marker=="blood" ~"Blood Type"
                               )) %>%
                mutate(other_marker=ifelse(marker %in% color_variable,
                                                     pretty_marker,"Other")) %>%
                group_by(end_window) %>%
                  arrange(end_window,-importance) %>%
                  mutate(rank=1:n())

#identify other markers
othermarker_levels <- plot_df  %>% filter(other_marker!="Other") %>%distinct(other_marker,isotype) %>% arrange(isotype,other_marker) %>% pull(other_marker) %>% unique() %>% c("Other")

#add colors based on what the first ranking was
lastrank <- plot_df %>% ungroup()%>%
                filter(end_window==min(end_window)) %>%
                arrange(-importance) %>%
                left_join(data.frame(other_marker=othermarker_levels,
                                     color=c(
                                                    pals::brewer.reds(5)[3:5],
                                                    pals::brewer.greens(5)[3:5],
                                                    pals::brewer.blues(5)[3:5],
                                                    "black","grey")
                                     ))

#make the rank plot
rank_plot<-  plot_df %>%
                mutate(other_marker=factor(other_marker,levels=othermarker_levels))%>%
                filter(end_window<=600) %>%
                ggplot(aes(y=rank,x=end_window,col=other_marker,
                           group=marker))+
                     geom_line(aes(alpha=other_marker))+
                        scale_color_manual("Predictor",values=c(
                                                    pals::brewer.reds(5)[3:5],
                                                    pals::brewer.greens(5)[3:5],
                                                    pals::brewer.blues(5)[3:5],
                                                    "black","grey"))+
                        scale_alpha_manual("Predictor",values=c(rep(1,10),0.5))+
                        theme_cowplot()+
                        scale_x_continuous("Infection Window (Days)",breaks = 
                                                   c(30,90,180,270,365,540,600),
                                           limits = c(5,max(600))
                                           )+
                      
                        scale_y_continuous("Predictor",breaks=1:21,
                                           labels=lastrank$pretty_marker,
                                           trans="reverse",
                                           sec.axis = dup_axis(name=
                                                           "Importance Ranking",
                                                        labels= 1:21
                                                           )
                                           )+
                        theme(legend.position = "none",
                              axis.text.y.left = element_text(colour=lastrank$color)
                              )


#combine plots together
plot_grid(p_tv_cvAUC+theme(legend.position="bottom"),
          rank_plot,
          ncol=1,align="v",
          rel_heights = c(1,1.5),
          labels=c("A","B")
          )


```


\pagebreak

### `r tab_nums("multi-marker-cvAUC")`

Random forest models were fit using a the specified marker set and individual level factors including age, sex, and blood group. Mean and 95% confidence intervals for cvAUC are reported.


```{r multi-marker-cvAUC, eval=TRUE}
# marker_set_names <- c( "Vibriocidal &\nELISA Markers","Vibriocidal\nMarkers","ELISA\nMarkers","All MBA\nMarkers","IgG MBA\nMarkers", "IgA MBA\nMarkers","IgM MBA\nMarkers")

marker_cvAUC_list <- read_rds(
           "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/4_compare_cvAUC_markers_list.rds"
          )  



cv_marker_df <- data.frame()
times <- c(45,120,200,300)

for(k in names(marker_cvAUC_list)){
  for(j in as.character(times)){
        cv_marker_df <- bind_rows(cv_marker_df,
                                   marker_cvAUC_list[[k]][[j]][[4]] %>%
                                          mutate(
                                  model=k)
                                  )
  }
}
        
        
        

#make plot to compare overall models
cv_marker_df %>% 
              # mutate(model=str_replace(model,"Luminex","MBA")) %>%
              mutate(`Marker Set`= factor(model)) %>%
              mutate(Window= factor(end_window,labels =c("45-day","120-day","200-day","300-day")) ) %>% 
   mutate(CI=paste0(sprintf("%.2f",cvAUC)," (",
                   sprintf("%.2f",ci1),"-",
                   sprintf("%.2f",ci2),")")) %>%
  select(`Marker Set`,CI,Window) %>%
  spread(Window,CI) %>%
  flextable::flextable() %>%
  flextable::fontsize(size = 9,part="all") %>%
  flextable::autofit()

  

# 
# traditional_predictors <- casecon_analysis %>%
#                       filter(test_type == "Vibriocidal"|
#                                (test_type=="ELISA" &
#                                isotype %in% c("IgG","IgA"))
#                                ) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# vibonly_predictors <- casecon_analysis %>% filter(test_type=="Vibriocidal") %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# ELISA_predictors <- casecon_analysis %>%
#                       filter(
#                                (test_type=="ELISA" &
#                                isotype %in% c("IgG","IgA"))
#                                ) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# # get the luminex predictors
# key_antigens <- c("OgawaOSPBSA","InabaOSPBSA","CtxB","Sialidase","VCC","TcpA")
# 
# 
# Luminex_predictors <- casecon_analysis %>% filter(test_type=="Luminex") %>%
#                         filter(antigen %in% key_antigens) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# 
# Luminex_IgG_predictors <- casecon_analysis %>% filter(test_type=="Luminex") %>%
#                         filter(isotype=="IgG") %>%
#                         filter(antigen %in% key_antigens) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# Luminex_IgA_predictors <- casecon_analysis %>% filter(test_type=="Luminex") %>%
#                         filter(isotype=="IgA") %>%
#                         filter(antigen %in% key_antigens) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# 
# Luminex_IgM_predictors <- casecon_analysis %>% filter(test_type=="Luminex") %>%
#                         filter(isotype=="IgM") %>%
#                         filter(antigen %in% key_antigens) %>%
#                         distinct(full_test) %>%
#                         pull(full_test) %>%
#                         c("age","sex","blood")
# #
# # IgG_varimp180 <- cforest_vimp(make_formula("inf_180", Luminex_IgG_predictors),
# #                               wide_analysis %>% getTimeBasedWeights(end_window = 180),
# #                               ntree=tree_param, weighted = TRUE
# #                               )
# #
# #
# # saveRDS(IgG_varimp180,paste0("source/final_code/luminex_recommendation/generated_rds/",Sys.Date(),"_",tree_param,"_IgG180_importance.rds"))
# 
# # IgG_varimp180 <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/2021-08-26_5000_IgG180_importance.rds")
# 
# 
# # IgG_varimp180$importance %>%
# #       mutate(antigen=str_remove(Biomarker,"Luminex_")) %>%
# #       mutate(antigen=str_remove(antigen,"IgA_|IgM_|IgG_")) %>%
# #       ggplot(aes(x=Cond_Importance,y=reorder(antigen,Cond_Importance)))+
# #       geom_col()+
# #       ylab("Antigen")+
# #       xlab("Conditional Importance")
# 
# 
# # First show which isotype is most important
# marker_set <- list(
#                       `Vibriocidal &\nELISA Markers`=traditional_predictors,
#                       `Vibriocidal\nMarkers`=vibonly_predictors,
#                       `ELISA\nMarkers`=ELISA_predictors,
#                      `All MBA\nMarkers`=Luminex_predictors,
#                      `IgG MBA\nMarkers`=Luminex_IgG_predictors,
#                      `IgA MBA\nMarkers`=Luminex_IgA_predictors,
#                      `IgM MBA\nMarkers`=Luminex_IgM_predictors
#                      )



```

\pagebreak

### `r tab_nums("panel-select")`

Random forest models were using a reduced panel of MBA IgG markers and individual level factors including age, sex, and blood group. Mean and 95% confidence intervals for cvAUC are reported.

```{r panel-select, eval=TRUE}

compareAntigen_cvAUC <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/5_cvAUC_combo.rds"
          )  %>%
        filter(type=="RAU") %>%
        filter(isotype=="IgG")


#make plot to compare antigens
compareAntigen_cvAUC_plotdf<- compareAntigen_cvAUC %>%
          arrange(end_window) %>%
          group_by(end_window) %>%
          mutate( panel = added,
                  panel= str_remove(panel,"RAU_IgG_"),
                  panel= str_replace(panel,"OSPBSA"," OSP"),
                  panel =ifelse(panel=="CtxB","CT-B",panel)
                  ) %>%
        mutate(panel=ifelse(panel=="CT-B",panel,paste("+",panel))) %>%
        ungroup()



compareAntigen_cvAUC_df<- compareAntigen_cvAUC_plotdf %>%
          mutate(
                 Window=paste0(end_window,"-day"),
                 Window=factor(Window,levels=c("45-day","120-day","200-day","300-day"))
                 ) %>%
          mutate(`MBA Panel for IgG` = factor(panel,levels= distinct(compareAntigen_cvAUC_plotdf,panel) %>% pull(panel))) %>%
          filter(`MBA Panel for IgG` != "+ Demographics Only") 



compareAntigen_cvAUC_df %>% 
   mutate(CI=paste0(sprintf("%.2f",cvAUC)," (",
                   sprintf("%.2f",ci1),"-",
                   sprintf("%.2f",ci2),")")) %>%
  select(`MBA Panel for IgG`,CI,Window) %>%
  spread(Window,CI) %>%
  flextable::flextable() %>%
  flextable::fontsize(size = 9,part="all") %>%
  flextable::autofit()



```

\pagebreak

### `r fig_nums("fig4-netmfi")`

Random forest models were fit using a specified marker set and individual level factors including age, sex, and blood type (A). Estimated mean and 95% confidence intervals for cvAUC are reported. Models fit to reduced panels of IgG MBA markers are shown (B). The order of how antigens were added was determined by the variable importance when fitting a model with only IgG MBA markers.

```{r fig4-netmfi, fig.height = 5, eval=TRUE}

#bring in the marker sets defined for part A
marker_set <- read_rds(
          paste0("source/final_code/luminex_recommendation/generated_rds/random_forest_results/",
                 "cvAUC_importance/4_marker_set.rds")
)


figure_set <- names(marker_set)[c(1:7)]


cv_marker_df <- read_rds(
          paste0( "source/final_code/luminex_recommendation/generated_rds/random_forest_results/",
                 "cvAUC_importance/4_compare_cvAUC_markers_df.rds")
          )

#make plot to compare overall models
cv_marker_plot <- cv_marker_df %>%
                filter(model %in% figure_set) %>%
              mutate(model=str_replace(model,"NetMFI","MBA")) %>%
              mutate(`Marker Set`= factor(model,levels=str_replace(figure_set,"NetMFI","MBA")) ) %>%
                mutate(Window=paste0(end_window,"-day")) %>%
              mutate(Window= factor(Window,levels=c("45-day","120-day","200-day","300-day")) ) %>%

              ggplot()+
                  geom_point(aes(y=cvAUC,x=`Marker Set`,col=Window),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(x=`Marker Set`,col=Window,
                                   ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.7,1))+
                  scale_color_brewer(palette ="Set2")+

                  theme_bw()+
                  theme(axis.text.x = element_text(angle=45,hjust=1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank())


# Figure out which antigens are most important for IgG
compareAntigen_cvAUC <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/5_cvAUC_combo.rds"
          )  %>%
        filter(isotype=="IgG",type=="NetMFI")

compareAntigen_cvAUC_plot<- compareAntigen_cvAUC %>%
          arrange(end_window) %>%
          group_by(end_window) %>%
          mutate( 
                  panel= str_remove(added,"NetMFI_IgG_"),
                  panel= str_replace(panel,"OSPBSA"," OSP"),
                  panel =ifelse(panel=="CtxB","CT-B Only",panel)
                  ) %>%
        mutate(panel=ifelse(panel=="CT-B Only",panel,paste("+",panel))) %>%
        ungroup() %>%
          mutate(
                 Window=paste0(end_window,"-day"),
                 Window=factor(Window,levels=c("45-day","120-day","200-day","300-day"))
                 ) %>%
          mutate(`MBA Panel for IgG` = factor(panel,levels= distinct(.,panel) %>% pull(panel))) %>%
              ggplot(aes(x=`MBA Panel for IgG`,col=Window))+
                  geom_point(aes(y=cvAUC),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.7,1))+
                  scale_color_brewer(palette ="Set2")+
                  theme_bw()+
                  theme(axis.text.x =  element_text(angle=45, hjust = 1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank()
                        )#+
                  # annotate("rect", xmin = 2.5, xmax = 3.5, ymin = 0.7, ymax = 1,
                  #          col="black",fill=NA,lty=2)





b_legend <- ggpubr::get_legend(
                        cv_marker_plot +
                        theme(legend.position = "bottom"))

r2 <- plot_grid(
        plot_grid(cv_marker_plot+
            theme(legend.position = "none"),
          compareAntigen_cvAUC_plot+
            theme(legend.position = "none"),align="h",
          labels=c("A","B")
          ), b_legend ,ncol=1, rel_heights = c(10,1)
        )

r2

```


\pagebreak

### `r fig_nums("fig5-netmfi")`

Median and 95% credible intervals are shown for the estimated (A) nominal specificity (black dashed line) and (B) time-varying sensitivity. Each row represents a different method for acquiring a cut-off including the Youden Index or maximizing sensitivity for a desired value of specificity. The relationship between logit(sensitivity) and time since infection (log-transformed) was constant for the 45-day window, linear for the 120-day, quadratic for the 200-day window, and cubic for the 300-day window. Traditional = vibriocidal Ogawa, vibriocidal Inaba, and 4 ELISA markers, All MBA = 18 MBA markers, All MBA IgG = 6 MBA markers, Reduced panel= Ogawa OSP, Inaba OSP, and CT-B IgG. All models also included age, sex, and blood type as predictors.

```{r fig5-netmfi, eval=TRUE}

tvsens_df <-read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/tvsens-spec/tvsens_df.rds") %>%
        mutate(seropos_type = case_when(
                        seropos_type == "youden_seropos" ~ "Youden Index",
                        seropos_type == "spec99_seropos" ~ "99% Specificity",
                        seropos_type == "spec95_seropos" ~ "95% Specificity",
                        seropos_type == "spec90_seropos" ~ "90% Specificity"
                        )) %>%
        mutate(seropos_type=factor(seropos_type,
                                   levels=c("Youden Index",
                                            "90% Specificity",
                                            "95% Specificity",
                                            "99% Specificity")))
spec_df <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/tvsens-spec/spec_df.rds") %>%
        mutate(seropos_type = case_when(
                        seropos_type == "youden_seropos" ~ "Youden Index",
                        seropos_type == "spec99_seropos" ~ "99% Specificity",
                        seropos_type == "spec95_seropos" ~ "95% Specificity",
                        seropos_type == "spec90_seropos" ~ "90% Specificity"
                        )) %>%
        mutate(seropos_type=factor(seropos_type,
                                   levels=c("Youden Index",
                                            "90% Specificity",
                                            "95% Specificity",
                                            "99% Specificity")))
raw_df <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/tvsens-spec/raw_df.rds")

avg_sens_df <- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/tvsens-spec/avgsens_df.rds") %>%
        mutate(seropos_type = case_when(
                        seropos_type == "youden_seropos" ~ "Youden Index",
                        seropos_type == "spec99_seropos" ~ "99% Specificity",
                        seropos_type == "spec95_seropos" ~ "95% Specificity",
                        seropos_type == "spec90_seropos" ~ "90% Specificity"
                        )) %>%
        mutate(seropos_type=factor(seropos_type,
                                   levels=c("Youden Index",
                                            "90% Specificity",
                                            "95% Specificity",
                                            "99% Specificity")))


#choose which variables you want to include
sens_spec_vars <- c("Traditional (with non-Immuno)" ,"All NetMFI (with non-Immuno)", "All NetMFI IgG (with non-Immuno)",
                    "Reduced Panel NetMFI (with non-Immuno)"
                    )




#make plots
p1 <- spec_df %>% 
        filter(variables %in% sens_spec_vars)%>%
        mutate(variables=str_remove_all(variables,"with non-Immuno|\\(|\\)")) %>%
        mutate(variables=str_replace(variables,"NetMFI","MBA")) %>%
        ggplot(aes(x=factor(end_window),col=variables))+
                geom_point(aes(y=median),position=position_dodge2(.5))+
                geom_linerange(aes(ymin=lb,ymax=ub),
                               position=position_dodge2(.5))+
                geom_hline(data=data.frame(seropos_type=factor(c("Youden Index",
                                            "90% Specificity",
                                            "95% Specificity",
                                            "99% Specificity"),
                                   levels=c("Youden Index",
                                            "90% Specificity",
                                            "95% Specificity",
                                            "99% Specificity")),
                                           yint=c(NA,0.90,0.95,0.99)
                                           ),
                           aes(yintercept=yint),
                           lty=2
                           )+
        scale_y_continuous("Specificity")+
        facet_grid(seropos_type~.,scales = "free")+
        xlab("Infection window")+
        scale_color_brewer(palette="Set2","Markers")+
        scale_fill_brewer(palette="Set2","Markers")+
                theme_bw()+
        theme(legend.position = "bottom",
              panel.grid.minor = element_blank(),
             panel.grid.major.x  = element_blank()

              )



 p2 <-  tvsens_df %>% 
        filter(time<end_window) %>%
        filter(variables %in% sens_spec_vars)%>%
        mutate(variables=str_remove_all(variables,"with non-Immuno|\\(|\\)")) %>%
        mutate(variables=str_replace(variables,"NetMFI","MBA")) %>%
        ggplot(aes(col=variables,fill=variables))+
        geom_line(aes(y=median,x=time))+
        geom_ribbon(aes(x=time,ymin=lb,ymax=ub),
                    alpha=0.1,col=NA
        )+
        geom_rug(data=raw_df %>% filter(truth==1#,
                                        # model=="Weighted"
                                        ) %>%
                         distinct(sample,day_actual,end_window),
                 sides="b", alpha=0.1,
                 aes(x=day_actual),inherit.aes = FALSE
                 ) +
        geom_rug(data=avg_sens_df %>%
        filter(variables %in% sens_spec_vars)%>%
        mutate(variables=str_remove_all(variables,"with non-Immuno|\\(|\\)")) %>%
        mutate(variables=str_replace(variables,"NetMFI","MBA")) ,
                 sides="r",
                 aes(y=sens)
                 )+
        scale_y_continuous("Sensitivity", limits=c(0,1),
                                   breaks=c(0,0.2,0.5,0.8,1))+

        scale_x_continuous("Days since infection",
                           breaks=c(7,45,120,200,300)
                           )+
        scale_color_brewer(palette="Set2","Markers")+
        scale_fill_brewer(palette="Set2","Markers")+
        theme_bw()+
        facet_grid(seropos_type~end_window,scales="free_x",space="free_x")+
         theme(panel.grid.minor = element_blank(),
               panel.grid.major.x  = element_blank()
               )


plot_grid(p1 + theme(legend.position = "none"),
          p2 + theme(legend.position = "none"),
          rel_widths = c(1,3),align = "h",axis = c("tb"),
          labels=c("A","B")
          ) %>%
plot_grid(ggpubr::get_legend(p1),ncol=1,rel_heights = c(10,1))


```


\pagebreak

### `r fig_nums("no-ctb-cvAUC")`

(A) Random forest models were fit using a the specified marker set and individual level factors including age, sex, and blood group. Estimated mean and 95% confidence intervals for cvAUC are reported. (B-D) Models fit to reduced panels of IgG, IgA, and IgM MBA markers are shown. 

```{r no-ctb-cvAUC, eval=TRUE}


marker_cvAUC_list_noctb <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/6_cvAUC_list_noctb.rds"
          )  

times <- c(45,120,200,300)

cv_marker_df <- data.frame()

for(k in names(marker_cvAUC_list_noctb)){
  for(j in as.character(times)){
        cv_marker_df <- bind_rows(cv_marker_df,
                                   marker_cvAUC_list_noctb[[k]][[j]][[4]] %>%
                                          mutate(
                                  model=k)
                                  )
  }
}

#make plot to compare overall models
cv_marker_plot <- cv_marker_df %>%
              mutate(model=str_replace(model,"Luminex","MBA")) %>%
              mutate(`Marker Set`= factor(model,levels=names(marker_cvAUC_list_noctb)) ) %>%
                mutate(Window=paste0(end_window,"-day")) %>%
              mutate(Window= factor(Window,levels=c("45-day","120-day","200-day","300-day")) ) %>%

              ggplot()+
                  geom_point(aes(y=cvAUC,x=`Marker Set`,col=Window),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(x=`Marker Set`,col=Window,
                                   ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.4,1))+
                  scale_color_brewer(palette ="Set2")+

                  theme_bw()+
                  theme(axis.text.x = element_text(angle=45,hjust=1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank())

# Figure out which antigens are most important for IgG
compareAntigen_cvAUC_IgG <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/7_cvAUC_combo_noctxb.rds"
          )  %>% filter(isotype=="IgG") %>%
        filter(type=="RAU") %>%
          arrange(end_window) %>%
          group_by(end_window) %>%
          mutate( panel = added,
                  panel= str_remove(panel,"RAU_IgG_"),
                  panel= str_replace(panel,"OSPBSA"," OSP"),
                  panel =ifelse(panel=="CtxB","CT-B",panel)
                  ) %>%
        mutate(panel=ifelse(panel=="Ogawa OSP",panel,paste("+",panel))) %>%
        ungroup()


compareAntigen_cvAUC_plot_IgG<- compareAntigen_cvAUC_IgG %>%
          mutate(
                 Window=paste0(end_window,"-day"),
                 Window=factor(Window,levels=c("45-day","120-day","200-day","300-day"))
                 ) %>%
          mutate(`MBA Panel for IgG` = factor(panel,levels= distinct(compareAntigen_cvAUC_IgG,panel) %>% pull(panel))) %>%
              ggplot(aes(x=`MBA Panel for IgG`,col=Window))+
                  geom_point(aes(y=cvAUC),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.4,1))+
                  scale_color_brewer(palette ="Set2")+
                  theme_bw()+
                  theme(axis.text.x =  element_text(angle=45, hjust = 1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank()
                        )


# Figure out which antigens are most important for IgA
compareAntigen_cvAUC_IgA <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/7_cvAUC_combo_noctxb.rds"
          )  %>% filter(isotype=="IgA") %>%
        filter(type=="RAU") %>%
          arrange(end_window) %>%
          group_by(end_window) %>%
          mutate( panel = added,
                  panel= str_remove(panel,"RAU_IgA_"),
                  panel= str_replace(panel,"OSPBSA"," OSP"),
                  panel =ifelse(panel=="CtxB","CT-B",panel)
                  ) %>%
        mutate(panel=ifelse(panel=="Ogawa OSP",panel,paste("+",panel))) %>%
        ungroup()


compareAntigen_cvAUC_plot_IgA<- compareAntigen_cvAUC_IgA %>%
          mutate(
                 Window=paste0(end_window,"-day"),
                 Window=factor(Window,levels=c("45-day","120-day","200-day","300-day"))
                 ) %>%
          mutate(`MBA Panel for IgA` = factor(panel,levels= distinct(compareAntigen_cvAUC_IgA,panel) %>% pull(panel))) %>%
              ggplot(aes(x=`MBA Panel for IgA`,col=Window))+
                  geom_point(aes(y=cvAUC),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.4,1))+
                  scale_color_brewer(palette ="Set2")+
                  theme_bw()+
                  theme(axis.text.x =  element_text(angle=45, hjust = 1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank()
                        )



# Figure out which antigens are most important for IgM
compareAntigen_cvAUC_IgM <- read_rds(
          "source/final_code/luminex_recommendation/generated_rds/random_forest_results/cvAUC_importance/7_cvAUC_combo_noctxb.rds"
          )  %>% filter(isotype=="IgM") %>%
        filter(type=="RAU") %>%
          arrange(end_window) %>%
          group_by(end_window) %>%
          mutate( panel = added,
                  panel= str_remove(panel,"RAU_IgM_"),
                  panel= str_replace(panel,"OSPBSA"," OSP"),
                  panel =ifelse(panel=="CtxB","CT-B",panel)
                  ) %>%
        mutate(panel=ifelse(panel=="Ogawa OSP",panel,paste("+",panel))) %>%
        ungroup()


compareAntigen_cvAUC_plot_IgM<- compareAntigen_cvAUC_IgM %>%
          mutate(
                 Window=paste0(end_window,"-day"),
                 Window=factor(Window,levels=c("45-day","120-day","200-day","300-day"))
                 ) %>%
          mutate(`MBA Panel for IgM` = factor(panel,levels= distinct(compareAntigen_cvAUC_IgM,panel) %>% pull(panel))) %>%
              ggplot(aes(x=`MBA Panel for IgM`,col=Window))+
                  geom_point(aes(y=cvAUC),position = position_dodge(width = 0.3))+
                  geom_linerange(aes(ymin=ci1,ymax=ci2),position = position_dodge(width = 0.3))+
                  scale_y_continuous(limits=c(0.4,1))+
                  scale_color_brewer(palette ="Set2")+
                  theme_bw()+
                  theme(axis.text.x =  element_text(angle=45, hjust = 1),
                        panel.grid.minor = element_blank(),
                        panel.grid.major.x = element_blank()
                        )





b_legend <- ggpubr::get_legend(
                        cv_marker_plot +
                        theme(legend.position = "bottom"))




plot_grid(
        plot_grid(cv_marker_plot+
            theme(legend.position = "none"),
          compareAntigen_cvAUC_plot_IgG+
            theme(legend.position = "none"),align="h",
          labels=c("A","B")
          ),
        plot_grid(compareAntigen_cvAUC_plot_IgA+
            theme(legend.position = "none"),
          compareAntigen_cvAUC_plot_IgM+
            theme(legend.position = "none"),align="h",
          labels=c("C","D")
          ),
        b_legend ,ncol=1, rel_heights = c(10,10,1)
        ) 





```

\pagebreak





```{r marker-cutoff, eval=FALSE}


### `r fig_nums("marker-cutoff")`

# Individuals were considered seropositive if their RAU was above the cut-off for both anti-Ogawa OSP IgG and anti-CT-B IgG. Sensitivity and specificity were estimated using a hierarchical logistic regression model with only an intercept fixed effect. The red dot represents the point where specificity is  90%, anti-OgawaOSP IgG RAU -4.0, and then maximizing sensitivity. 

# We then estimated the specificity and (non-time-varying) sensitivity when using a cut-off requirement (for anti-Ogawa OSP IgG and anti-CT-B IgG) to be identified as a case infected in the last 120 days (Figure S24). The sum of sensitivity and specificity was maximized when anti-CT-B IgG was -3.1 log10(RAU-1) and anti-Ogawa OSP IgG was unrestricted. An approach relying on both markers (anti-CT-B IgG: -3.1 log10(RAU-1) and anti-Ogawa OSP IgG: -4.0 log10(RAU-1) resulted in a specificity of 97% and sensitivity of 60%.

# We then explored the performance of simple numeric thresholds based on the two most predictive antibody measurements (anti-Ogawa OSP IgG and anti-CT-B IgG). Using the threshold that maximized both sensitivity and specificity (Youden Index) a single cutoff for CTB led to sensitivities ranging from X-X and specificities from Z-Z depending on the infection window of interest.Bivariate thresholds using both markers resulted in a sensitivities ranging from XX-XX and specificities from YY-YY. 



fit_ssy_df<- read_rds("source/final_code/luminex_recommendation/generated_rds/random_forest_results/tvsens-spec/cutoff_fit_ssy_df.rds")
 
p1 <- wide_analysis %>%addInfectionWindow(120) %>%
                mutate(`Recently Infected`=inf_120)%>%
                ggplot(aes(x=Luminex_IgG_CtxB,y=Luminex_IgG_OgawaOSPBSA))+
                        geom_point(aes(col=`Recently Infected`,shape=status),alpha=0.5)+
                        theme_bw()+
                geom_hline(yintercept=-4,lty=2)+
                geom_vline(xintercept=-3.1,lty=2)+
                ylab("anti-Ogawa OSP IgG")+
                xlab("anti-CT-B IgG")+
                theme_bw()
        
p2 <- fit_ssy_df %>% ggplot(aes(x=Luminex_IgG_CtxB,y=Luminex_IgG_OgawaOSPBSA))+
                geom_tile(aes(fill=sens))+
                scale_fill_viridis_c("Sensitivity")+
                # scale_fill_fermenter(palette="BuGn",
                #                      direction=1,
                #                      breaks=c(0.5,0.6,0.7,0.9))+
                geom_point(inherit.aes = FALSE,
                           x=-3.1,y=-4,col="red"
                           )+
                ylab("anti-Ogawa OSP IgG")+
                xlab("anti-CT-B IgG")+
                theme_bw()

p3 <- fit_ssy_df %>% ggplot(aes(x=Luminex_IgG_CtxB,y=Luminex_IgG_OgawaOSPBSA))+
                geom_tile(aes(fill=spec))+
                scale_fill_viridis_c("Specificity")+
                # scale_fill_fermenter(
                #         palette="BuGn",
                #                      direction=1,
                #         breaks=c(0.9,0.95,0.99))+
                geom_point(inherit.aes = FALSE,
                           x=-3.1,y=-4,col="red"
                           )+
                ylab("anti-Ogawa OSP IgG")+
                xlab("anti-CT-B IgG")+
                theme_bw()

p4 <- fit_ssy_df %>% ggplot(aes(x=Luminex_IgG_CtxB,y=Luminex_IgG_OgawaOSPBSA))+
                geom_tile(aes(fill=youden))+
                scale_fill_viridis_c("Youden\nIndex")+
                geom_point(inherit.aes = FALSE,
                           x=-3.1,y=-4,col="red"
                           )+
                ylab("anti-Ogawa OSP IgG")+
                xlab("anti-CT-B IgG")+
                theme_bw()


plot_grid(p1,p2,p3,p4,
          labels=c("A","B","C","D")
          )




```


